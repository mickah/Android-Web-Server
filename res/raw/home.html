<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
	<meta charset="utf-8">
  <title>CAWS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
	<link href="../../assets/css/bootstrap.css" rel="stylesheet">
	<link href="../../assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

</head>

<body onload="startChatUpdate()">
<div class="container-fluid">
	<div class="page-header">
		<h2>CAWS <small>Chat on android web server</small> </h2>
	</div>
	
	<p></p>

	<textarea id="msgViewer" rows="10" readonly="readonly" style="resize:none"></textarea>
	<p></p>
	<textarea id="msgToSend" rows="1" maxlength="200" style="resize:none"></textarea>
	<p></p>
	<p>
		<form class="form-inline">
			<button class="btn btn-primary" type="button" onclick="request(null,'chat',sendNewChatMessage())">Send message</button>
			<div class="input-prepend">
				<span class="add-on">as</span>
				<input class="span1" id="author" type="text" placeholder="Username" maxlength="20">
			</div>
		</form>
	</p>
</div>

<script type="text/javascript">
<!-- 
CHAT_VIEWER = "msgViewer"
CHAT_WRITER = "msgToSend"
CHAT_AUTHOR = "author"

function getXMLHttpRequest() {
	var xhr = null;

	if (window.XMLHttpRequest || window.ActiveXObject) {
		if (window.ActiveXObject) {
			try {
				xhr = new ActiveXObject("Msxml2.XMLHTTP");
			} catch(e) {
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			}
		} else {
			xhr = new XMLHttpRequest(); 
		}
	} else {
		alert("Your browser doesn't support the XMLHTTPRequest object...");
		return null;
	}
	return xhr;
}

// Send a POST request whose URI is "uri" and body contains "messageToSend". 
//The result of the request is proceed by the "callback" function
function request(callback, uri, messageToSend) {
	var xhr = getXMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0)) {
			if(callback != null)			
				callback(xhr.responseText);
		}
	};
	xhr.open("POST", uri, true);
	xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	xhr.send(JSON.stringify(messageToSend));
}

function sendNewChatMessage() {
	var xhr = getXMLHttpRequest();
	var msg = document.getElementById(CHAT_WRITER).value;
	document.getElementById(CHAT_WRITER).value = "";
	return { message:msg, command:"newMessage", 
					author:document.getElementById(CHAT_AUTHOR).value }
}

function waitingChatUpdateCommand( _lastMsgId){
	return { command:"waitingUpdate", lastMsgId:_lastMsgId }
}

// loop to update the chat viewer
function updateChatViewer(oData) {
	var parsedData = JSON.parse(oData);
	document.getElementById(CHAT_VIEWER).value += parsedData.updateContent;
	document.getElementById(CHAT_VIEWER).scrollTop = 99999;
	request(updateChatViewer,"chat",waitingChatUpdateCommand(parsedData.msgId));
}

function startChatUpdate(){
		request(updateChatViewer,"chat",waitingChatUpdateCommand(-1));
}
//-->
</script>
<!-- 	<script src="../assets/js/bootstrap.js"></script> -->
</body>
</html>
